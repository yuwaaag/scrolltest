<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>PTN News Live - Professional Master</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; color: white; }
        .studio { position: relative; width: 100vw; height: 100vh; background: url('studio.jpg') center/cover no-repeat; background-color: #111; }
        
        /* ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤ */
        .visual-box { position: absolute; right: 5%; top: 12%; width: 42%; height: 40%; border: 4px solid #00f2ff; border-radius: 12px; overflow: hidden; z-index: 5; background:#000; box-shadow: 0 0 20px rgba(0,242,255,0.4); }
        #newsImg { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s; }

        /* ‡§ü‡•á‡§≤‡•Ä‡§™‡•ç‡§∞‡•â‡§Æ‡•ç‡§™‡•ç‡§ü‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü */
        .script-box { position: absolute; left: 3%; top: 12%; width: 45%; height: 60%; background: rgba(0, 0, 0, 0.85); border-left: 10px solid #ff0000; padding: 30px; box-sizing: border-box; z-index: 5; overflow: hidden; }
        #teleprompter { position: relative; font-size: 32px; line-height: 1.6; top: 100%; font-weight: 500; }

        /* ‡§è‡§Ç‡§ï‡§∞ ‡§ï‡•à‡§®‡§µ‡§∏ */
        .anchor-container { position: absolute; right: 0; bottom: 0; width: 65%; height: 100%; z-index: 10; pointer-events: none; display: flex; justify-content: flex-end; align-items: flex-end; }
        #anchorCanvas { max-width: 100%; max-height: 100%; }
        #anchorVid { display: none; }

        /* ‡§¨‡•ç‡§∞‡•á‡§ï‡§ø‡§Ç‡§ó ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§ü‡§ø‡§ï‡§∞ */
        .ticker-bar { position: absolute; bottom: 0; width: 100%; height: 85px; background: linear-gradient(90deg, #cc0000, #660000); display: flex; align-items: center; z-index: 20; border-top: 4px solid #fff; }
        #flashTicker { font-size: 40px; font-weight: bold; color: #fff; width: 100%; }
    </style>
</head>
<body>

<div class="studio">
    <div class="visual-box"><img id="newsImg" src=""></div>
    <div class="script-box"><div id="teleprompter">PTN NEWS: ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à... ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</div></div>
    <div class="anchor-container"><canvas id="anchorCanvas"></canvas></div>
    <video id="anchorVid" muted loop crossorigin="anonymous"><source src="anchor_video.mp4" type="video/mp4"></video>
    <div class="ticker-bar"><marquee id="flashTicker" scrollamount="12">PTN NEWS LIVE...</marquee></div>
</div>

<script>
    // üî¥ 1. ‡§Ö‡§™‡§®‡•Ä Google Sheet CSV ‡§≤‡§ø‡§Ç‡§ï ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç (Publish to Web ‡§µ‡§æ‡§≤‡•Ä)
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSoAjuzUEQRbN3UUJotq0E00dMk6H9VuYhxKqK4EeJ49m4LTTB5bnZZG-UjRoC3_-nZ6xW6WDMn0T5P/pub?gid=0&single=true&output=csv"; 

    // üî¥ 2. ‡§Ö‡§™‡§®‡•Ä Google Apps Script Web App URL ‡§Ø‡§π‡§æ‡§Å ‡§°‡§æ‡§≤‡•á‡§Ç
    const proxyUrl = "https://script.google.com/macros/s/AKfycbzgGAUTWBmBLrl8K_TYUHe5jodyba3Zh6Vxjeb5TaS29SzJHyYUUESoCGhHKzXP7ARm/exec"; 

    let newsItems = [];
    let newsIndex = 0;
    const video = document.getElementById("anchorVid");
    const canvas = document.getElementById("anchorCanvas");
    const ctx = canvas.getContext("2d", { willReadFrequently: true });

    // ‡§ï‡•ç‡§∞‡•ã‡§Æ‡§æ ‡§ï‡•Ä (Green Screen) ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    function processChroma() {
        if (video.paused) return;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        let frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < frame.data.length / 4; i++) {
            let r = frame.data[i*4], g = frame.data[i*4+1], b = frame.data[i*4+2];
            // ‡§π‡§∞‡§æ ‡§∞‡§Ç‡§ó ‡§π‡§ü‡§æ‡§®‡•á ‡§ï‡§æ ‡§≤‡•â‡§ú‡§ø‡§ï
            if (g > 100 && g > r * 1.3 && g > b * 1.1) {
                frame.data[i*4+3] = 0;
            }
        }
        ctx.putImageData(frame, 0, 0);
        requestAnimationFrame(processChroma);
    }

    // ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§´‡•ã‡§ü‡•ã ‡§´‡•á‡§ö ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    async function setPhoto(kw) {
        const img = document.getElementById("newsImg");
        img.style.opacity = 0;
        try {
            const response = await fetch(`${proxyUrl}?kw=${encodeURIComponent(kw)}`);
            const data = await response.json();
            img.src = data.url;
            img.onload = () => img.style.opacity = 1;
        } catch (e) {
            console.error("Visual fetch error:", e);
            img.src = "https://loremflickr.com/800/450/news"; // ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§´‡•ã‡§ü‡•ã
            img.style.opacity = 1;
        }
    }

    // ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    async function loadData() {
        try {
            console.log("Loading News...");
            const res = await fetch(csvUrl + "?cache=" + Date.now());
            if (!res.ok) throw new Error("Sheet URL is not responding (400/404)");
            
            const data = await res.text();
            const rows = data.split('\n').slice(1);
            
            newsItems = rows.map(r => {
                const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (c.length < 2) return null;
                return {
                    script: (c[0] || "").replace(/"/g, "").trim(),
                    visual: (c[1] || "").replace(/"/g, "").trim(),
                    flash: (c[2] || "").replace(/"/g, "").trim()
                };
            }).filter(i => i !== null && i.script.length > 5);

            if (newsItems.length > 0) playNews();
            else alert("‡§∂‡•Ä‡§ü ‡§Æ‡•á‡§Ç ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ! ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ ‡§è‡§ï ‡§ñ‡§¨‡§∞ ‡§≤‡§ø‡§ñ‡•á‡§Ç‡•§");
            
        } catch (e) {
            console.error("Master Error:", e);
            document.getElementById("teleprompter").innerText = "Error: " + e.message;
        }
    }

    function playNews() {
        const item = newsItems[newsIndex];
        const prompter = document.getElementById("teleprompter");
        
        // UI ‡§Ö‡§™‡§°‡•á‡§ü
        prompter.style.transition = "none";
        prompter.style.top = "100%";
        prompter.innerText = item.script;
        document.getElementById("flashTicker").innerText = "PTN BREAKING: " + item.flash;

        // ‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§°‡•á‡§ü
        setPhoto(item.visual);

        // ‡§Ü‡§µ‡§æ‡§ú‡§º (Speech)
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(item.script);
        msg.lang = 'hi-IN';
        msg.rate = 0.9;

        msg.onstart = () => {
            video.play();
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight;
            processChroma();
            // ‡§∏‡•ç‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§ü ‡§è‡§®‡•Ä‡§Æ‡•á‡§∂‡§® ‡§∂‡•Å‡§∞‡•Ç
            setTimeout(() => {
                const duration = item.script.length * 0.16;
                prompter.style.transition = `top ${duration}s linear`;
                prompter.style.top = `-${prompter.offsetHeight + 100}px`;
            }, 300);
        };

        msg.onend = () => {
            video.pause();
            newsIndex = (newsIndex + 1) % newsItems.length;
            setTimeout(playNews, 2000); // 2 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§ó‡•à‡§™
        };
        window.speechSynthesis.speak(msg);
    }

    // üü¢ ‡§Ø‡•Ç‡§ú‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§™‡§∞ ‡§®‡•ç‡§Ø‡•Ç‡§ú‡§º ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç (Browser Requirement)
    window.onclick = () => {
        if (newsItems.length === 0) {
            document.getElementById("teleprompter").innerText = "‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...";
            loadData();
        }
    };
</script>
</body>
</html>
